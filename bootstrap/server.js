const http = require('http');
// –ü–æ–¥–∫–ª—é—á–∞–µ–º Express-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–Ω–∞—à app.js)
// –í Laravel —ç—Ç–æ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –∑–∞–≥—Ä—É–∑–∫–µ Kernel (HTTP kernel), –≥–¥–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è —Ä–æ—É—Ç—ã, middleware –∏ —Ç.–ø.
const app = require('../app');

// –ü–æ–¥–∫–ª—é—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞ (–ø–æ—Ä—Ç, —Ö–æ—Å—Ç –∏ —Ç.–¥.)
// –í Laravel —ç—Ç–æ –æ–±—ã—á–Ω–æ .env ‚Üí config/app.php
const config = require('../config/server');

// –í Node.js –µ—Å—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –º–æ–¥—É–ª—å 'http', —á–µ—Ä–µ–∑ –∫–æ—Ç–æ—Ä—ã–π —Ä–µ–∞–ª—å–Ω–æ –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è —Å–µ—Ä–≤–µ—Ä.
// Express —Å–∞–º –ø–æ —Å–µ–±–µ ‚Äî —ç—Ç–æ —Ç–æ–ª—å–∫–æ "–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤".
// –ü–æ—ç—Ç–æ–º—É –º—ã —Å–æ–∑–¥–∞—ë–º http-—Å–µ—Ä–≤–µ—Ä –∏ –ø—Ä–æ–∫–∏–¥—ã–≤–∞–µ–º —Ç—É–¥–∞ app.
const http = require('http');

/**
 * –°–æ–∑–¥–∞—ë–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä
 * –í Laravel —ç—Ç–∏–º –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è php-fpm –∏–ª–∏ artisan serve,
 * –∞ –∑–¥–µ—Å—å ‚Äî –º—ã –≤—Ä—É—á–Ω—É—é –≤—ã–∑—ã–≤–∞–µ–º http.createServer().
 */
function createServer() {
    // –°–æ–∑–¥–∞—ë–º —Å–µ—Ä–≤–µ—Ä –∏ –≥–æ–≤–æ—Ä–∏–º: "–∫–∞–∂–¥—ã–π –≤—Ö–æ–¥—è—â–∏–π –∑–∞–ø—Ä–æ—Å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–π —á–µ—Ä–µ–∑ –Ω–∞—à–µ Express-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"
    const server = http.createServer(app);

    // –ì–æ–≤–æ—Ä–∏–º —Å–µ—Ä–≤–µ—Ä—É —Å–ª—É—à–∞—Ç—å –Ω—É–∂–Ω—ã–π –ø–æ—Ä—Ç –∏ —Ö–æ—Å—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, http://localhost:3000)
    server.listen(config.port, () => {
        console.log(`üöÄ Server running at http://${config.host}:${config.port}`);
    });

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
     * (–í Laravel artisan serve —Å–∞–º –ø–∏—à–µ—Ç "address already in use").
     */
    server.on('error', (err) => {
        // –û—à–∏–±–∫–∞: —É –ø—Ä–æ—Ü–µ—Å—Å–∞ –Ω–µ—Ç –ø—Ä–∞–≤ —Å–ª—É—à–∞—Ç—å –ø–æ—Ä—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, <1024 –±–µ–∑ root)
        if (err.code === 'EACCES') {
            console.error(`Port ${config.port} requires elevated privileges`);
            process.exit(1); // –∑–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å —Å –æ—à–∏–±–∫–æ–π
        }

        // –û—à–∏–±–∫–∞: –ø–æ—Ä—Ç —É–∂–µ –∑–∞–Ω—è—Ç –¥—Ä—É–≥–∏–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º
        if (err.code === 'EADDRINUSE') {
            console.error(`Port ${config.port} is already in use`);
            process.exit(1);
        }

        // –õ—é–±–∞—è –¥—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞
        console.error(err);
        process.exit(1);
    });

    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—ä–µ–∫—Ç server (–≤–¥—Ä—É–≥ –≥–¥–µ-—Ç–æ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å, –Ω–∞–ø—Ä–∏–º–µ—Ä –¥–ª—è WebSocket)
    return server;
}

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –≤—ã–∑–≤–∞—Ç—å createServer() –∏–∑ bin/www –∏–ª–∏ index.js
// –í Laravel –æ–±—ã—á–Ω–æ artisan –∏–ª–∏ public/index.php –∑–∞–ø—É—Å–∫–∞—é—Ç –≤—Å—ë –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.
module.exports = createServer;

